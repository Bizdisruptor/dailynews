<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Cerf Report — Curated News</title>
  <style>
    :root { --blue:#0056b3; --ink:#1c1e21; --muted:#606770; --paper:#fff; --bg:#f0f2f5; --positive:#17823b; --negative:#b00020; }
    * { box-sizing:border-box; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:0}

    /* Banner */
    header.banner { position: relative; width:100%; height:220px; overflow:hidden; }
    .banner-img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    .banner-text {
      position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
      font-size:1rem; font-weight:600; color:#fff; background:rgba(0,0,0,.55);
      padding:6px 12px; border-radius:6px; text-align:center;
      white-space: normal; line-height:1.3; max-width:94%; overflow:hidden;
    }
    .mobile-tagline { display:none; padding:10px 14px 0; text-align:center; font-weight:600; line-height:1.35; }

    @media (max-width: 768px) {
      header.banner { height: 110px; }
      .banner-text { display:none; }
      .mobile-tagline { display:block; font-size:.9rem; }
    }
    @media (max-width: 480px) {
      header.banner { height: 90px; }
      .mobile-tagline { font-size:.85rem; padding-top:8px; }
    }

    .market {
      background:var(--paper); border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08);
      padding:12px 14px; margin:18px auto; max-width:1400px;
    }
    .market .row { display:flex; flex-wrap:wrap; gap:16px 24px; align-items:center; justify-content:center; }
    .chip { display:flex; gap:8px; align-items:center; font-size:1rem; }
    .chip a { color:inherit; text-decoration:none; font-weight:600; }
    .chip a:hover { text-decoration:underline; color:var(--blue); }
    .price { font-weight:600; min-width:90px; text-align:right; }

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:18px; max-width:1400px; margin:0 auto; padding:0 18px}
    .card{background:var(--paper);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:16px;overflow:hidden}
    .card h2{margin:0 0 8px;border-bottom:2px solid var(--blue);padding-bottom:8px;font-size:1.1rem}
    .section-link{margin:-4px 0 8px}
    .section-link a{font-size:.9rem;text-decoration:none}
    .section-link a:hover{text-decoration:underline}
    .list{max-height:520px;overflow-y:auto;padding-right:8px;min-height:100px}
    .item{margin:0 0 12px;border-bottom:1px solid #eee;padding:0 0 10px}
    .item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
    .item a{color:#0d6efd;text-decoration:none;font-weight:600}
    .item a:hover{text-decoration:underline}
    .item p{margin:6px 0 0;color:var(--muted);font-size:.92rem;line-height:1.35}
    .loading{text-align:center;padding:14px;color:var(--muted);line-height:1.4;}
    .smallnote{margin-top:8px;color:#8a8f98;font-size:.8rem}
    .footer{margin:16px auto 0;text-align:center;color:#8a8f98;font-size:.85rem;max-width:1400px}
  </style>
</head>
<body>
  <header class="banner">
    <img class="banner-img" src="The Cerf Report.png" alt="The Cerf Report banner" />
    <div class="banner-text">More signal. Less noise — curated analysis across tech, finance, and politics.</div>
  </header>
  <div class="mobile-tagline">More signal. Less noise — curated analysis across tech, finance, and politics.</div>

  <!-- Simple Market -->
  <div class="market">
    <div class="row" id="simple-market">
      <div class="chip" id="price-btc">
        <a href="https://www.google.com/finance/quote/BTC-USD" target="_blank" rel="noopener">Bitcoin (BTC)</a>
        <span class="price">—</span>
      </div>
      <div class="chip" id="price-xau">
        <a href="https://www.google.com/finance/quote/XAU-USD" target="_blank" rel="noopener">Gold (XAU)</a>
        <span class="price">—</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card" id="recommended-card">
      <h2>Recommended Reading</h2>
      <div class="list"><div class="loading">Loading…</div></div>
      <div class="smallnote" data-stamp></div>
    </div>

    <div class="card" id="cerf-card">
      <h2>The Cerf Report</h2>
      <div class="section-link">
        <a href="https://thecerfreport.substack.com/" target="_blank" rel="noopener noreferrer">
          thecerfreport.substack.com →
        </a>
      </div>
      <div class="list"><div class="loading">Loading…</div></div>
      <div class="smallnote" data-stamp></div>
    </div>

    <div class="card" id="front-card">
      <h2>Front Page</h2>
      <div class="list"><div class="loading">Loading…</div></div>
      <div class="smallnote" data-stamp></div>
    </div>

    <div class="card" id="tech-card">
      <h2>Technology</h2>
      <div class="list"><div class="loading">Loading…</div></div>
      <div class="smallnote" data-stamp></div>
    </div>

    <div class="card" id="world-card">
      <h2>World News</h2>
      <div class="list"><div class="loading">Loading…</div></div>
      <div class="smallnote" data-stamp></div>
    </div>

    <div class="card" id="finance-card">
      <h2>Finance</h2>
      <div class="list"><div class="loading">Loading…</div></div>
      <div class="smallnote" data-stamp></div>
    </div>
  </div>

  <div class="footer" id="updatedAt"></div>

  <script>
    // ---------- CONFIG ----------
    // If you ever open this page somewhere that's NOT your Netlify site, set NETLIFY_BASE.
    // Example: const NETLIFY_BASE = "https://thecerfreport.netlify.app";
    const NETLIFY_BASE = "";
    const ABS = (path) => new URL(path, NETLIFY_BASE || location.origin).toString();
    const $ = (sel, root=document) => root.querySelector(sel);

    // ---------- helpers ----------
    function setPrice(elId, value){
      const el = document.querySelector(`#${elId} .price`);
      el.textContent = (value == null)
        ? "—"
        : Number(value).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function decodeEntities(str=""){
      const d = document.createElement("textarea");
      d.innerHTML = str;
      return d.value.replace(/^<!\[CDATA\[/, "").replace(/\]\]>$/, "");
    }

    async function fetchJSON(url){
      const r = await fetch(url, { redirect: "follow" });
      const text = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status} ${url}: ${text.slice(0,120)}`);
      try { return JSON.parse(text); }
      catch { throw new Error(`Non-JSON from ${url}: ${text.slice(0,120)}`); }
    }

    // Accept raw arrays and various keys ({articles},{items},{data})
    const pickArticles = (d) => {
      if (!d) return [];
      if (Array.isArray(d)) return d;
      if (Array.isArray(d.articles)) return d.articles;
      if (Array.isArray(d.items)) return d.items;
      if (Array.isArray(d.data)) return d.data;
      return [];
    };

    function renderNewsList(listEl, articles, errText){
      if (!Array.isArray(articles) || articles.length === 0){
        listEl.innerHTML = `<div class="loading">${errText}</div>`;
        return;
      }
      listEl.innerHTML = "";
      for (const a of articles){
        const url = a.url || a.link || "#";
        const title = decodeEntities(a.title || a.name || "(untitled)");
        const desc = a.description || a.summary || "";
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${title}</a><p>${desc}</p>`;
        listEl.appendChild(div);
      }
    }

    function stamp(cardEl){
      const s = cardEl.querySelector('[data-stamp]');
      if (s) s.textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }

    const sectionDefs = [
      { id: "front-card",   section: "frontpage", label: "Front Page" },
      { id: "tech-card",    section: "tech",      label: "Technology" },
      { id: "world-card",   section: "world",     label: "World News" },
      { id: "finance-card", section: "finance",   label: "Finance" }
    ];

    // ---------- data fetchers ----------
    async function fetchMiniMarket(){
      const d = await fetchJSON(ABS("/.netlify/functions/mini-market"));
      const box = d?.data ?? d; // tolerate {data:{...}} or plain object
      return { btcUSD: box?.btcUSD ?? null, xauUSD: box?.xauUSD ?? null };
    }

    // Fallback chain for Recommended:
    // 1) function → 2) /recommended.json → 3) Substack archive (top 6)
    async function fetchRecommended(){
      // 1) Netlify function
      try {
        const d = await fetchJSON(ABS("/.netlify/functions/get-links"));
        const a = pickArticles(d);
        if (a.length) return a;
      } catch {}
      // 2) Static JSON (create /recommended.json in your repo root when ready)
      try {
        const d2 = await fetchJSON(ABS("/recommended.json"));
        const a2 = pickArticles(d2);
        if (a2.length) return a2;
      } catch {}
      // 3) Substack fallback
      try {
        const d3 = await fetchJSON(ABS("/.netlify/functions/substack?mode=archive"));
        const a3 = pickArticles(d3).slice(0, 6).map(x => ({
          title: x.title || x.name || "From The Cerf Report",
          url:   x.url   || x.link || "https://thecerfreport.substack.com/",
          description: x.description || x.summary || ""
        }));
        if (a3.length) return a3;
      } catch {}
      // If we get here, nothing worked
      return [];
    }

    async function fetchCerf(){
      const d = await fetchJSON(ABS("/.netlify/functions/substack?mode=archive"));
      return pickArticles(d);
    }

    async function loadSection({ id, section, label }){
      const listEl = document.querySelector(`#${id} .list`);
      try {
        const d = await fetchJSON(ABS("/.netlify/functions/news?section="+encodeURIComponent(section)));
        renderNewsList(listEl, pickArticles(d), `Could not load ${label}.`);
        stamp(document.getElementById(id));
      } catch (e) {
        renderNewsList(listEl, [], `Could not load ${label}.`);
      }
    }

    // ---------- orchestrator ----------
    async function updateAll(){
      // mini market (best-effort)
      fetchMiniMarket()
        .then(mm => { setPrice("price-btc", mm.btcUSD); setPrice("price-xau", mm.xauUSD); })
        .catch(() => { setPrice("price-btc", null); setPrice("price-xau", null); });

      // recommended (non-blocking)
      (async () => {
        const listEl = $("#recommended-card .list");
        try {
          const recs = await fetchRecommended();
          if (recs.length === 0) throw new Error("no data");
          renderNewsList(listEl, recs, "Could not load Recommended Reading.");
          stamp($("#recommended-card"));
        } catch {
          renderNewsList(listEl, [], "Could not load Recommended Reading.");
        }
      })();

      // others in parallel
      const cerfP = fetchCerf().catch(()=>[]);
      const sectionsP = Promise.all(sectionDefs.map(loadSection));

      const cerf = await cerfP;
      renderNewsList($("#cerf-card .list"), cerf, "Could not load The Cerf Report.");
      stamp($("#cerf-card"));

      await sectionsP;
      $("#updatedAt").textContent = `Updated ${new Date().toLocaleString()}`;

      // safety: after 6s, flip any remaining "Loading…" to a friendly message
      setTimeout(() => {
        document.querySelectorAll('.card .list').forEach(list => {
          if (list && /Loading…/.test(list.textContent || "")) {
            const cardTitle = list.closest('.card')?.querySelector('h2')?.textContent || "Section";
            list.innerHTML = `<div class="loading">Could not load ${cardTitle}.</div>`;
          }
        });
      }, 6000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateAll();
      setInterval(updateAll, 5*60*1000);
    });
  </script>
</body>
</html>
